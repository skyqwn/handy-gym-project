"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var n=0,t=Array(e.length);n<e.length;n++)t[n]=e[n];return t}return Array.from(e)}var body=document.querySelector("body"),modalContainer=document.querySelector(".modalContainer"),modalWrapper=document.querySelector(".modalWrapper"),croppperContainer=document.querySelector(".croppperContainer"),closeBtn=document.getElementById("closeBtn"),realFileInput=document.getElementById("realFileInput"),fakeFileBtn=document.getElementById("fakeFileBtn"),fakeFileInput=document.getElementById("fakeFileInput"),galleryPreview=document.getElementById("galleryPreview"),result=document.querySelector(".result"),saveBtn=document.querySelector(".save"),cropper=void 0,dataTransfer=new DataTransfer,startLoading=function(e){e.innerHTML="",e.classList.contains("fa-pen")?(e.classList.remove("fa-pen"),e.classList.add("fa-spinner"),e.classList.add("fa-spin-pulse")):(e.innerHTML='<i class="fa-solid fa-spinner fa-spin-pulse"></i>',e.disabled=!0)},endLoading=function(e){e.innerHTML="",e.innerHTML='<i class="fa-solid fa-camera" ></i>',e.disabled=!1},generateRandomId=function(){return Math.random().toString(16).slice(2)},compressFile=async function(e){var n;try{if(e)return(n=await imageCompression(e,{maxSizeMB:1,maxWidthOrHeight:1280,initialQuality:.8,useWebWorker:!1})).name=(e.name||"힙합")+"_compressed",convertBlobToFile(n)}catch(e){console.log(e),alert("파일 올리는 도중 오류발생")}},convertBlobToFile=function(e){return new File([e],e.name||"preview",{type:"images/*"})},openModal=function(){modalContainer.style.transform="translateY(0)",modalWrapper.style.top=window.scrollY+"px",body.style.overflowY="hidden"},closeModal=function(){modalContainer.style.transform="translateY(-100%)",body.style.overflowY="scroll"},generateBtnContainer=function(n,t){var e=document.createElement("div"),a=(e.classList.add("previewContainer__btn"),document.createElement("div")),r=(a.innerHTML='<i class="fa-solid fa-crop-simple"></i>',a.classList.add("cropBtn"),a.addEventListener("click",function(e){return openCrop(t,n)}),document.createElement("div")),i=(r.innerHTML='<i class="fa-solid fa-pen"></i>',r.classList.add("deleteBtn"),r.addEventListener("click",function(e){return changeFile(n,e.target)}),document.createElement("div"));return i.innerHTML='<i class="fa-solid fa-xmark"></i>',i.classList.add("deleteBtn"),i.addEventListener("click",function(e){return deletePreview(n)}),e.append(r),e.append(a),e.append(i),e},paintPreview=function(e,n){var t=URL.createObjectURL(n.file),a=document.createElement("div"),r=(a.id=e,a.classList.add("previewContainer"),a.classList.add("galleryPreview"),document.createElement("img")),e=(r.src=t,r.classList.add("previewContainer__img"),generateBtnContainer(e,t)),t=document.createElement("textarea");t.name="captions",t.placeholder="사진에 대한 설명을 적어보세요. (선택사항)",n.caption&&(t.value=n.caption),a.append(r),a.append(e),a.append(t),galleryPreview.append(a)},updatePreview=function(e,n,t){var a=URL.createObjectURL(t.file),e=document.getElementById(e),r=(e.innerHTML="",e.id=n,document.createElement("img")),n=(r.src=a,r.classList.add("previewContainer__img"),generateBtnContainer(n,a)),a=document.createElement("textarea");a.name="captions",a.placeholder="사진에 대한 설명을 적어보세요. (선택사항)",t.caption&&(a.value=t.caption),e.append(r),e.append(n),e.append(a)},deletePreview=function(e){confirm("정말 삭제하시겠습니까?")&&(document.getElementById(e).remove(),deleteImgData(e))},cropSave=function(e,a){e.preventDefault(),cropper.getCroppedCanvas({minWidth:256,minHeight:256,maxWidth:1280,maxHeight:1280}).toBlob(function(e){var n=generateRandomId(),e=convertBlobToFile(e),t=findCaption(a);updatePreview(a,n,{file:e,caption:t}),updateImgToData(e,a,n),closeModal()})},openCrop=function(e,n){openModal(),croppperContainer.innerHTML="";var t=document.createElement("img"),e=(t.src=e,document.createElement("div"));e.addEventListener("click",function(e){return cropSave(e,n)}),e.innerText="저장",e.classList.add("saveBtn"),e.classList.add("btn"),croppperContainer.appendChild(t),modalWrapper.appendChild(e),cropper=new Cropper(t,{aspectRatio:4/3,zoomable:!1})},findCaption=function(e){e=document.getElementById(e).querySelector("textarea").value;return e||""},changeFile=function(a,r){var e=document.createElement("input");e.type="file",e.click(),e.addEventListener("change",async function(e){var n=generateRandomId(),e=e.target.files[0],e=(startLoading(r),await compressFile(e)),t=findCaption(a);updatePreview(a,n,{file:e,caption:t}),updateImgToData(e,a,n)})},newImgTodData=function(e,n){e.id=n,dataTransfer.items.add(e),realFileInput.files=dataTransfer.files},updateImgToData=function(n,t,e){n.id=e;var a=Array.from(dataTransfer.files).map(function(e){return t===e.id?n:e});dataTransfer.items.clear();for(var r=0;r<a.length;r++)dataTransfer.items.add(a[r]);realFileInput.files=dataTransfer.files},deleteImgData=function(n){var e=[].concat(_toConsumableArray(dataTransfer.files)).findIndex(function(e){return e.id===n});dataTransfer.items.remove(e),realFileInput.files=dataTransfer.files},handleChange=async function(e){var e=e.target.files[0],n=generateRandomId(),e=(startLoading(fakeFileBtn),await compressFile(e));paintPreview(n,{file:e,caption:""}),newImgTodData(e,n),endLoading(fakeFileBtn)},init=function(){fakeFileBtn.addEventListener("click",function(e){e.preventDefault(),fakeFileInput.click()}),fakeFileInput.addEventListener("change",handleChange);var n=document.querySelectorAll(".originalPhoto"),t=document.querySelectorAll(".originalCaption");0<n.length&&window.addEventListener("load",async function(){for(var e=0;e<n.length;e++)await async function(e,n){var t=document.createElement("canvas");t.height=e.naturalHeight,t.width=e.naturalWidth,t.getContext("2d").drawImage(e,0,0);try{var a=generateRandomId(),r=await new Promise(function(n){return t.toBlob(function(e){return n(e)})}),i=convertBlobToFile(r),o=(i.id=a,n.value);paintPreview(a,{file:i,caption:o}),newImgTodData(i,a)}catch(e){console.log(e),alert("미리보기 생성 중 오류발생")}}(n[e],t[e])}),closeBtn.addEventListener("click",closeModal)};init();